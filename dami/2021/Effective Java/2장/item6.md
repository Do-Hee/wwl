# 아이템6 - 불필요한 객체 생성을 피하라
성능 향상을 위한 기법

### 시작 전에 알아둘 사항
이번 아이템은 **방어적 복사**를 다루는 아이템 50과 대조적인 내용
- 아이템6 : 기존 객체를 재사용해야 한다면 새로운 객체를 만들지 마라
- 아이템50 : 새로운 객체를 만들어야 한다면 기존 객체를 재사용하지 마라

중요한 것은 **방어적 복사를 하지 않으면 각종 버그와 보안**에 문제가 발생하지만, **불필요한 객체 생성은 그저 코드 형태와 성능에만 영향**을 준다는 점

상황에 따라 어느 것이 더 중요한지 판단하여 적절히 사용할 것

<br />

### 불필요한 객체 생성을 피하라
똑같은 기능의 객체를 매번 생성하는 것보다 객체 하나를 재사용하는 것이 이득일 때가 많으며, 특히 **불변 객체**는 언제든 재사용 가능

### 재사용 방법 1. 불변 객체 String
```JAVA
// 사용하지 말아야 할 예 - 새로운 객체 생성
String str = new String("bikini");
```
- 실행될 때마다 새로운 ```String``` 인스턴스 생성
- 생성자에 넘겨진 문자열 자체가 생성할 ```String```과 기능적으로 완전히 일치하기 때문에 굳이 새로운 인스턴스를 생성하는 것은 불필요한 행위

```JAVA
// 개선된 방법 - String pool 활용
String str = "bikini";
String str2 = "bikini";
```
- 매번 새로운 인스턴스를 만들지 않고 한 개의 ```String``` 인스턴스를 사용하는 방법
- 문자열 리터럴이 힙 영역에 있는 **String pool**에 저장되며, ```str2```는 이미 String pool에 있는 동일한 ```String``` 인스턴스를 참조
- ```==```로 동등 비교 가능

<br />

### 재사용 방법 2. 정적 팩토리 메소드
```JAVA
// 사용하지 말아야 할 예 - 새로운 객체 생성 (JAVA 9에서 deprecated)
Boolean bool = new Boolean("hello");
```
```JAVA
// 개선된 방법 - 정적 팩토리 메소드 사용
Boolean bool = Boolean.valueOf("hello");
```
- 생성자는 호출할 때마다 매번 새로운 객체를 생성하지만, 정적 팩토리 메소드는 불변 객체 뿐 아니라 가변 객체라도 사용 중 변경의 여지가 없다면 재사용

<br />

### 재사용 방법 3. 생성 비용이 비싼 객체
대표적으로 ```Pattern``` 객체가 있으며, 비싼 객체가 반복적으로 필요하다면 **캐싱해두고 재사용**하는 것이 좋은 방법
```JAVA
// 사용하지 말아야 할 예 - String.matches 메소드 사용
static boolean isOnlyNumber(String s){
  return s.matches("[0-9]");
}
```
- ```String```의 ```matches``` 메소드는 내부에서 정규표현식용 ```Pattern``` 인스턴스를 매번 생성하는 방식
- 또한, ```Pattern```은 입력받은 정규표현식의 유한 상태 머신(finite state machine)을 만들기 떄문에 생성 비용이 높은 객체
  - 유한 상태 머신?
    - 시작과 도착을 포함한 유한 개의 상태 노드가 있고, 각 상태가 조건에 따라 다른 상태로 전이되는 동작 구조
    - 일반적인 탐색과 달리 모든 상태와 전이를 찾아두고 매칭하기 때문에 생성 비용이 높지만 생성 이후에는 빠른 매칭 속도
  - [유한 상태 머신 JAVA 코드 참고 영상](https://www.youtube.com/watch?v=ZfW7FwuBd90)
  - [Pattern 객체의 유한 상태 머신 참고 자료](https://github.com/java-squid/effective-java/issues/6#issuecomment-696519565)

```JAVA
// 개선된 방법 - Pattern.compile() 하여 재사용
public class RomanNumerals {
  private static final Pattern NUMBER = Pattern.compile("[0-9]");

  static boolean isOnlyNumber(String s) {
    return NUMBER.matcher(s).matches();
  }
}
```
- ```Pattern``` 객체를 딱 한 번만 ```compile```하여 훨씬 개선된 성능
- 단, 클래스 초기화 후 ```isOnlyNumber``` 메소드가 사용되지 않는다면 초기화는 불필요한 과정이기 때문에 **지연 초기화** 방법을 사용할 수도 있지만, 권장되는 방법은 아님(아이템 83)
  - 코드가 복잡해지지만 성능이 크게 개선되지 않을 때가 많기 때문(아이템 67)

<br />

### 이번 아이템에서 주의할 점
- 단순히 객체 생성 비용은 비싸니 최대한 피해야 하는 것이라고 생각하기 보다 상황에 따라 적절히 사용하는 것이 중요
- 최근 JVM에서는 작은 객체를 생성하고 회수하는 일이 부담되지 않는 수준
- 프로그램의 명확성, 간결성, 기능을 위해 객체를 추가로 생성하는 것은 옳은 일
- 또한, 아주 무거운 객체가 아닌 이상 자체 객체 풀을 만드는 것은 코드를 헷갈리게 하고, 메모리 사용량을 늘리고, 성능을 떨어뜨리기 때문에 주의 필요
