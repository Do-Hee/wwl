# [item 50] 적시에 방어적 복사본을 만들라 
### 사전 조사 
- 버퍼 오버런, 배열 오버런
  -  컴퓨터 보안과 프로그래밍에서는 프로세스가 데이터를 버퍼에 저장할 때 프로그래머가 지정한 곳 바깥에 저장하는 것을 의미한다. 
  - 버퍼 오버플로는 보통 데이터를 저장하는 과정에서 그 데이터를 저장할 메모리 위치가 유효한지를 검사하지 않아 발생한다. 
  - 이로 인해 잘못된 프로그램 거동이 나타날 수 있으며, 메모리 접근 오류, 잘못된 결과, 프로그램 종료, 또는 시스템 보안 누설이 발생할 수 있다.  
  - C와 C++
    - 어떤 영역의 메모리에서도 내장된 데이터 접근 또는 덮어쓰기 보호 기능을 제공하지 않으며 어떤 배열에 기록되는 데이터가 그 배열의 범위 안에 포함되는지 자동으로 검사하지 않는다.
- 와일드 포인터(dangling pointer, wild pointer)
  - 해제된 메모리를 가리키는 포인터
  - 유효하지 않은 목적지 주소에 대한 참조
  - 적절한 타입의 유효한 객체를 가리키고 있지 않는 포인터
  - 해제된 메모리를 가리키고 있기 때문에 이 공간에 접근할 시 이상 동작을 할 수 있음
  - 허상 포인터 상태가 아닌 널포인터 상태로 처리해 주는 것이 좋음
  - [Reference](https://zetawiki.com/wiki/%ED%97%88%EC%83%81_%ED%8F%AC%EC%9D%B8%ED%84%B0)
- 기간을 표현하는 클래스
  - Date(가변) -> Insteant(불변), LocalDateTime, ZonedDateTime
- 방어적 복사(Defensive copy)
  - 원본이 아닌 복사본을 만들어 사용 
- 첫 번쨰. 생성자 수정 
  - Period 인스턴스 안에서는 원본이 아닌 복사본 사용 
  - 방어적 복사본 -> 복사본으로 유효성 검사 구현 
  - `clone` 사용 X
    - Date가 final이 아니므로 clone이 악의를 가진 하위 클래스의 인스턴스를 반환할 수도 있기 때문 (즉, 매개변수가 제 3자에 의해 확장될 수 있는 타입이라면 방어적 복사본을 만들 때 clone을 사용하면 안됨.)
    - 정적 리스트에 담아줬다가 공격자에게 해당 리스트를 접근할 수 있도록 넘겨줄수도.. (Period 인스턴스 자체를 송두리째 맡기는 꼴)
- 두 번째. 접근자 수정
  - 접근자에서 가변 필드의 방어적 복사본 반환
  - clone 사용 가능
    - Period가 가지고 있는 Date 객체는 java.util.Date임이 확실하기 때문 (즉, 신뢰할 수 없는 하위 클래스가 아니다.)
  - 네이티브 메서드(Java Native method, 이하 JNI): 다른 언어로 작성된 코드를 자바에서 호출하도록 만들어진 규약
    - [Ref](https://roughexistence.tistory.com/81)
  - 리플렉션: 구체적인 클래스 타입을 알지 못해도 그 클래스의 메서드, 타입, 변수들에 접근할 수 있도록 해주는 자바 API
    - [Ref](https://brunch.co.kr/@kd4/8)
- **검사시점/사용시전(time-of-check/time-of-use) 공격** 혹은 **TOCTOU 공격**
  - 멀티스레딩 환경에서 원본 객체의 유효성 건사 후 복사본을 만드는 찰나의 순간에 다른 스레드가 원본 객체를 수정할 위험이 있는 것

- 배열의 불변 뷰
  - 배열을 private으로 만들고 그 복사본을 반환하는 public 메서드를 추가하는 방법 
  
```java
private static final Thing[] PRIVATE_VALUE = { ... };
public static final Thing[] values() {
  return PRIVATE_VALUE.clone();
}
```
 
---

### 스터디 요약 
- 직교(orthogonal)의 개념
  - 리팩토링 관점. 기능을 원자적으로 쪼개다 보면 자연스럽게 중복이 줄고 결합성이 낮아져 코드를 수정하기 수월해진다.
- 예시 
  - // Delf 추가 예정 

---

> :leftwards_arrow_with_hook:[EffectiveJava3E](/EffectiveJava3E/README.md)

